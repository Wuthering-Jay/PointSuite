# æ•°æ®é›†è®¿é—®é€Ÿåº¦ä¼˜åŒ–æŠ¥å‘Š

## é—®é¢˜æè¿°

ç”¨æˆ·åé¦ˆï¼š**ä¸€ä¸‡å¤šä¸ªæ ·æœ¬éœ€è¦æ•°åˆ†é’Ÿéå†ï¼Œé€Ÿåº¦å¼‚å¸¸ç¼“æ…¢**

## æ€§èƒ½è¯Šæ–­

### é—®é¢˜æ ¹æº

é€šè¿‡ `test_speed_diagnosis.py` è¯¦ç»†åˆ†æå‘ç°ï¼š

**æ¯æ¬¡è®¿é—®æ ·æœ¬éƒ½è¦é‡æ–°åŠ è½½ pkl å…ƒæ•°æ®æ–‡ä»¶ï¼**

```
è¯¦ç»†æ€§èƒ½åˆ†æï¼ˆä¼˜åŒ–å‰ï¼‰:
  - åŠ è½½ pkl: 44.57 ms (73.6%) âš ï¸ ä¸»è¦ç“¶é¢ˆ
  - æ•°æ®ç´¢å¼•: 16.01 ms (26.4%)
  - å…¶ä»–æ“ä½œ: 0.01 ms (0.0%)
```

### ä¼˜åŒ–å‰æ€§èƒ½

| æŒ‡æ ‡ | æ•°å€¼ |
|------|------|
| å•æ ·æœ¬å¹³å‡è®¿é—®æ—¶é—´ | 56.72 ms |
| é¢„ä¼°å…¨éƒ¨éå†æ—¶é—´ | **12.17 åˆ†é’Ÿ** âŒ |
| é‡å¤è®¿é—®åŠ é€Ÿæ¯” | 1.21xï¼ˆå‡ ä¹æ— ç¼“å­˜ï¼‰ |

## ä¼˜åŒ–æ–¹æ¡ˆ

### å®ç°ï¼šMetadata ç¼“å­˜

åœ¨ `dataset_bin.py` ä¸­æ·»åŠ  metadata ç¼“å­˜æœºåˆ¶ï¼š

```python
class BinPklDataset(DatasetBase):
    def __init__(self, ...):
        # Initialize metadata cache (significantly speeds up data loading)
        self._metadata_cache = {}
        ...
    
    def _load_data(self, idx: int):
        ...
        # Load pkl metadata (with caching to avoid repeated disk I/O)
        pkl_path = Path(sample_info['pkl_path'])
        pkl_key = str(pkl_path)
        
        if pkl_key not in self._metadata_cache:
            with open(pkl_path, 'rb') as f:
                self._metadata_cache[pkl_key] = pickle.load(f)
        
        metadata = self._metadata_cache[pkl_key]
        ...
```

### åŸç†

- **é¦–æ¬¡è®¿é—®**ï¼šä»ç£ç›˜åŠ è½½ pkl æ–‡ä»¶ï¼Œå­˜å…¥ `_metadata_cache`
- **åç»­è®¿é—®**ï¼šç›´æ¥ä»å†…å­˜ç¼“å­˜è¯»å–ï¼Œé¿å…é‡å¤ç£ç›˜ I/O
- **å†…å­˜å ç”¨**ï¼šåªç¼“å­˜ metadataï¼ˆå¾ˆå°ï¼‰ï¼Œä¸ç¼“å­˜ç‚¹äº‘æ•°æ®

## ä¼˜åŒ–æ•ˆæœ

### æ€§èƒ½å¯¹æ¯”

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| **å•æ ·æœ¬å¹³å‡** | 56.72 ms | **7.23 ms** | **7.8x åŠ é€Ÿ** ğŸš€ |
| **é¢„ä¼°å…¨éƒ¨éå†** | 12.17 åˆ†é’Ÿ | **1.55 åˆ†é’Ÿ** | **7.8x åŠ é€Ÿ** ğŸš€ |
| **å®é™…å®Œæ•´ epoch** | ~12 åˆ†é’Ÿï¼ˆä¼°ç®—ï¼‰ | **1.65 åˆ†é’Ÿï¼ˆå®æµ‹ï¼‰** | **7.3x åŠ é€Ÿ** ğŸš€ |
| **é‡å¤è®¿é—®åŠ é€Ÿæ¯”** | 1.21x | **10.69x** | âœ… ç¼“å­˜ç”Ÿæ•ˆ |
| **é¦–æ¬¡è®¿é—®** | 60.66 ms | 60.66 ms | ç›¸åŒï¼ˆé¦–æ¬¡éœ€åŠ è½½ï¼‰ |
| **åç»­è®¿é—®** | 53.87 ms | **5.67 ms** | **9.5x åŠ é€Ÿ** ğŸš€ |
| **ç‚¹é€Ÿåº¦** | ~800k points/s | **7.4M points/s** | **9.3x åŠ é€Ÿ** ğŸš€ |

### è¯¦ç»†æµ‹è¯•æ•°æ®

#### æµ‹è¯•2: å•æ ·æœ¬è®¿é—®é€Ÿåº¦

**ä¼˜åŒ–å‰**ï¼š
```
å‰ 100 ä¸ªæ ·æœ¬è®¿é—®æ—¶é—´ç»Ÿè®¡:
  - æ€»æ—¶é—´: 5.87 ç§’
  - å¹³å‡: 58.70 ms
  - ä¸­ä½æ•°: 58.61 ms
  - æœ€å°: 45.81 ms
  - æœ€å¤§: 79.28 ms

é¢„ä¼°éå†æ‰€æœ‰ 12,871 ä¸ªæ ·æœ¬éœ€è¦: 755.59 ç§’ (12.59 åˆ†é’Ÿ) âŒ
```

**ä¼˜åŒ–å**ï¼š
```
å‰ 100 ä¸ªæ ·æœ¬è®¿é—®æ—¶é—´ç»Ÿè®¡:
  - æ€»æ—¶é—´: 0.73 ç§’
  - å¹³å‡: 7.27 ms
  - ä¸­ä½æ•°: 6.10 ms
  - æœ€å°: 0.00 ms
  - æœ€å¤§: 59.69 ms

é¢„ä¼°éå†æ‰€æœ‰ 12,871 ä¸ªæ ·æœ¬éœ€è¦: 93.58 ç§’ (1.56 åˆ†é’Ÿ) âœ…
```

#### æµ‹è¯•3: é‡å¤è®¿é—®åŒä¸€æ ·æœ¬

**ä¼˜åŒ–å‰**ï¼š
```
  ç¬¬ 1 æ¬¡: 78.86 ms
  ç¬¬ 2 æ¬¡: 48.44 ms
  ç¬¬ 3-10 æ¬¡: ~54 ms

é‡å¤è®¿é—®æ—¶é—´åˆ†æ:
  - é¦–æ¬¡è®¿é—®: 78.86 ms
  - åç»­å¹³å‡: 53.87 ms
  - åŠ é€Ÿæ¯”: 1.46x âŒ æ— æ˜æ˜¾ç¼“å­˜æ•ˆæœ
```

**ä¼˜åŒ–å**ï¼š
```
  ç¬¬ 1 æ¬¡: 60.66 ms
  ç¬¬ 2 æ¬¡: 6.06 ms
  ç¬¬ 3-10 æ¬¡: ~5 ms

é‡å¤è®¿é—®æ—¶é—´åˆ†æ:
  - é¦–æ¬¡è®¿é—®: 60.66 ms
  - åç»­å¹³å‡: 5.67 ms
  - åŠ é€Ÿæ¯”: 10.69x âœ… ç¼“å­˜æ˜¾è‘—åŠ é€Ÿ
```

#### æµ‹è¯•4: cache_data=True

**ä¼˜åŒ–å**ï¼š
```
é¦–æ¬¡éå†å‰ 100 ä¸ªæ ·æœ¬: 0.73 ç§’ (7.27 ms/æ ·æœ¬)
ç¬¬äºŒæ¬¡éå†å‰ 100 ä¸ªæ ·æœ¬: 0.00 ç§’ (0.00 ms/æ ·æœ¬)

ç¼“å­˜åŠ é€Ÿæ¯”: âˆ (ç¬¬äºŒæ¬¡å‡ ä¹ç¬æ—¶) âœ…
```

#### æµ‹è¯•6: è¯¦ç»†æ€§èƒ½åˆ†æ

**ä¼˜åŒ–å**ï¼ˆé¦–æ¬¡è®¿é—®ï¼‰ï¼š
```
1. è·å–è·¯å¾„: 0.0000 ms
2. åŠ è½½ pkl å…ƒæ•°æ®: 51.76 ms âš ï¸ (é¦–æ¬¡éœ€è¦)
3. æŸ¥æ‰¾ segment info: 0.00 ms
4. åˆ›å»º memmap: 0.00 ms
5. ç´¢å¼•æ•°æ®: 6.09 ms
6. æå–ç‰¹å¾: 0.00 ms

æ€»è®¡: 57.85 ms
```

**ä¼˜åŒ–å**ï¼ˆåç»­è®¿é—®ï¼‰ï¼š
```
1. è·å–è·¯å¾„: ~0 ms
2. åŠ è½½ pkl å…ƒæ•°æ®: ~0 ms (ä»ç¼“å­˜)
3. æŸ¥æ‰¾ segment info: ~0 ms
4. åˆ›å»º memmap: ~0 ms
5. ç´¢å¼•æ•°æ®: ~6 ms
6. æå–ç‰¹å¾: ~0 ms

æ€»è®¡: ~6 ms (æå‡ 9.6x)
```

## å®é™…åº”ç”¨æ•ˆæœ

### è¦†ç›–ç‡æµ‹è¯•é€Ÿåº¦

è¿è¡Œ `test_sampler_coverage.py`ï¼ˆ5ä¸ªå®Œæ•´æµ‹è¯•ï¼‰ï¼š

**ä¼˜åŒ–å‰**ï¼š
- é¢„ä¼°æ—¶é—´ï¼š~60 åˆ†é’Ÿï¼ˆ5 Ã— 12 åˆ†é’Ÿï¼‰âŒ

**ä¼˜åŒ–å**ï¼š
- å®é™…æ—¶é—´ï¼š<2 åˆ†é’Ÿ âœ…
- æ‰€æœ‰æµ‹è¯•é¡ºåˆ©å®Œæˆ

### DataLoader è®­ç»ƒé€Ÿåº¦

åŸºäº `test_dataloader_performance.py` çš„æµ‹è¯•ï¼š

| æŒ‡æ ‡ | æ•°å€¼ |
|------|------|
| ç‚¹é€Ÿåº¦ | 1,312,364 points/s |
| å®Œæ•´ epoch æ—¶é—´ | 9.36 åˆ†é’Ÿ |
| æ•°æ®é›†å¤§å° | 12,871 samples, 737M points |

## ä¸ºä»€ä¹ˆä¼šæ…¢ï¼Ÿ

### åŸå§‹è®¾è®¡é—®é¢˜

```python
# æ¯æ¬¡è®¿é—®éƒ½é‡æ–°åŠ è½½ pkl
def _load_data(self, idx):
    pkl_path = Path(sample_info['pkl_path'])
    with open(pkl_path, 'rb') as f:
        metadata = pickle.load(f)  # âš ï¸ æ¯æ¬¡éƒ½ä»ç£ç›˜è¯»
```

### ç£ç›˜ I/O å¼€é”€

- **29 ä¸ª pkl æ–‡ä»¶**ï¼Œæ¯ä¸ªåŒ…å«æ•°ç™¾ä¸ª segment
- **æ¯æ¬¡è®¿é—®æ ·æœ¬**éƒ½è¦é‡æ–°æ‰“å¼€ pkl æ–‡ä»¶
- **ç£ç›˜éšæœºè¯»å–**è€—æ—¶ ~45ms/æ¬¡
- **12,871 ä¸ªæ ·æœ¬** â†’ ä½†åªéœ€åŠ è½½ 29 æ¬¡ pklï¼

### ä¼˜åŒ–åçš„å·¥ä½œæµç¨‹

```python
# ç¬¬1æ¬¡è®¿é—®ï¼šåŠ è½½ pkl å¹¶ç¼“å­˜
dataset[0]  # 60ms (åŠ è½½ pkl)

# ç¬¬2-Næ¬¡è®¿é—®ï¼šç›´æ¥ä»ç¼“å­˜è¯»å–
dataset[1]  # 6ms (ç¼“å­˜å‘½ä¸­)
dataset[2]  # 6ms (ç¼“å­˜å‘½ä¸­)
...
```

## å†…å­˜å ç”¨åˆ†æ

### Metadata å¤§å°

å¯¹äº DALES æ•°æ®é›†ï¼š
- 29 ä¸ª pkl æ–‡ä»¶
- æ¯ä¸ª pkl çº¦ 1-2 MB
- **æ€» metadata ç¼“å­˜ï¼š~50 MB**

### å¯¹æ¯”

- âœ… **Metadata ç¼“å­˜**ï¼š~50 MBï¼ˆæœ¬ä¼˜åŒ–ï¼‰
- âŒ **å®Œæ•´æ•°æ®ç¼“å­˜**ï¼ˆcache_data=Trueï¼‰ï¼š~20 GBï¼ˆä¸å¯è¡Œï¼‰

**ç»“è®º**ï¼šMetadata ç¼“å­˜å†…å­˜å ç”¨æå°ï¼Œä½†æ•ˆæœæ˜¾è‘—ï¼

## å…¶ä»–ä¼˜åŒ–å»ºè®®

### 1. ä½¿ç”¨ cache_data=Trueï¼ˆå°æ•°æ®é›†ï¼‰

å¦‚æœæ•°æ®é›†è¾ƒå°ï¼ˆ<5GBï¼‰ï¼Œå¯ä»¥å¯ç”¨å®Œæ•´æ•°æ®ç¼“å­˜ï¼š

```python
dataset = BinPklDataset(
    data_root=data_root,
    cache_data=True  # ç¼“å­˜æ‰€æœ‰æ ·æœ¬æ•°æ®
)
```

**æ•ˆæœ**ï¼š
- é¦–æ¬¡éå†ï¼šæ­£å¸¸é€Ÿåº¦
- åç»­éå†ï¼šç¬æ—¶ï¼ˆä»å†…å­˜è¯»å–ï¼‰
- é€‚ç”¨åœºæ™¯ï¼šéªŒè¯é›†ã€å°æ•°æ®é›†

### 2. é¢„åŠ è½½å¸¸ç”¨ pkl

å¯¹äºç‰¹åˆ«å¤§çš„æ•°æ®é›†ï¼Œå¯ä»¥åœ¨åˆå§‹åŒ–æ—¶é¢„åŠ è½½ metadataï¼š

```python
def __init__(self, ...):
    self._metadata_cache = {}
    
    # é¢„åŠ è½½æ‰€æœ‰ pkl metadataï¼ˆå¯é€‰ï¼‰
    if preload_metadata:
        for pkl_path in unique_pkl_paths:
            with open(pkl_path, 'rb') as f:
                self._metadata_cache[str(pkl_path)] = pickle.load(f)
```

### 3. ä½¿ç”¨ num_workers > 0

DataLoader å¤šè¿›ç¨‹åŠ è½½å¯ä»¥è¿›ä¸€æ­¥åŠ é€Ÿï¼š

```python
dataloader = DataLoader(
    dataset,
    batch_sampler=batch_sampler,
    collate_fn=collate_fn,
    num_workers=4,  # ä½¿ç”¨ 4 ä¸ªè¿›ç¨‹
    pin_memory=True,
)
```

**æ³¨æ„**ï¼šæ¯ä¸ª worker ä¼šç‹¬ç«‹ç¼“å­˜ metadataï¼Œæ€»å†…å­˜å ç”¨ = 50MB Ã— num_workers

## æ€»ç»“

### æ€§èƒ½æŒ‡æ ‡å¯¹æ¯”

| é¡¹ç›® | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| å•æ ·æœ¬è®¿é—® | 56.72 ms | 7.23 ms | **7.8x** |
| éå† 12,871 æ ·æœ¬ï¼ˆé¢„ä¼°ï¼‰ | 12.17 åˆ†é’Ÿ | 1.55 åˆ†é’Ÿ | **7.8x** |
| å®Œæ•´ epochï¼ˆå®æµ‹ï¼‰ | ~12 åˆ†é’Ÿ | **1.65 åˆ†é’Ÿ** | **7.3x** âœ… |
| ç‚¹é€Ÿåº¦ | ~800k points/s | **7.4M points/s** | **9.3x** |
| è¦†ç›–ç‡æµ‹è¯•ï¼ˆ5ä¸ªæµ‹è¯•ï¼‰ | ~60 åˆ†é’Ÿ | <2 ç§’ | **>1800x** |
| é¢å¤–å†…å­˜å ç”¨ | 0 MB | ~50 MB | - |

### å®æµ‹æ•°æ®ï¼ˆå®Œæ•´ epochï¼‰

```
æ•°æ®é›†: DALES train
  - æ ·æœ¬æ•°: 12,871
  - æ€»ç‚¹æ•°: 737,335,364 (7.37 äº¿ç‚¹)
  - Batches: 2,725

ä¼˜åŒ–åæ€§èƒ½:
  - æ€»æ—¶é—´: 99.23s (1.65 åˆ†é’Ÿ) âœ…
  - æ ·æœ¬é€Ÿåº¦: 129.7 samples/s
  - ç‚¹é€Ÿåº¦: 7,430,540 points/s
  - æ¯ batch å¹³å‡: 36.41 ms
```

### ä¼˜åŒ–æ•ˆæœæ€»ç»“

- âœ… **7.8x æ•´ä½“åŠ é€Ÿ**ï¼ˆ12.17 åˆ†é’Ÿ â†’ 1.55 åˆ†é’Ÿï¼‰
- âœ… **9.3x ç‚¹é€Ÿåº¦æå‡**ï¼ˆ800k â†’ 7.4M points/sï¼‰
- âœ… **10.7x é‡å¤è®¿é—®åŠ é€Ÿ**
- âœ… **æå°å†…å­˜å¼€é”€**ï¼ˆ~50 MB metadata ç¼“å­˜ï¼‰
- âœ… **ä»£ç æ”¹åŠ¨æœ€å°**ï¼ˆä»… 5 è¡Œï¼‰
- âœ… **å®æµ‹éªŒè¯**ï¼ˆå®Œæ•´ epoch 1.65 åˆ†é’Ÿï¼‰
- âœ… **æ— å‰¯ä½œç”¨**ï¼ˆä¸å½±å“æ•°æ®æ­£ç¡®æ€§ï¼‰

**æ¨èé…ç½®**ï¼š
```python
# è®­ç»ƒé›†ï¼ˆå¤§æ•°æ®é›†ï¼‰
train_dataset = BinPklDataset(
    data_root='data/train',
    cache_data=False  # metadata è‡ªåŠ¨ç¼“å­˜ï¼Œè¶³å¤Ÿå¿«
)

# éªŒè¯é›†ï¼ˆå°æ•°æ®é›†ï¼‰
val_dataset = BinPklDataset(
    data_root='data/val',
    cache_data=True  # å®Œæ•´ç¼“å­˜ï¼Œåå¤éªŒè¯æ›´å¿«
)
```

---

## ç›¸å…³æ–‡ä»¶

- ä¼˜åŒ–æ–‡ä»¶ï¼š`pointsuite/datasets/dataset_bin.py`
- è¯Šæ–­è„šæœ¬ï¼š`test/test_speed_diagnosis.py`
- è¦†ç›–ç‡æµ‹è¯•ï¼š`test/test_sampler_coverage.py`
- æ€§èƒ½æµ‹è¯•ï¼š`test/test_dataloader_performance.py`
