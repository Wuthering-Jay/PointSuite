"""
DALES 数据集训练配置

数据集信息：
- 训练集：E:\data\DALES\dales_las\bin\train
- 测试集：E:\data\DALES\dales_las\bin\test
- 类别：0-8 (9个类别)，其中 0 为噪声需要忽略
- 实际类别：1-8 映射到 0-7 (8个类别)
- 特征：coord + echo (echo 包含两个维度：是否为首次/末次回波)
"""

# ============================================================================
# 数据集配置
# ============================================================================
data:
  type: BinPklDataModule
  
  # 数据路径
  train_data: E:\data\DALES\dales_las\bin\train
  val_data: E:\data\DALES\dales_las\bin\train  # 使用训练集的一部分作为验证集
  test_data: E:\data\DALES\dales_las\bin\test
  predict_data: E:\data\DALES\dales_las\bin\test
  
  # 数据加载配置
  assets: [coord, echo]  # echo 包含 2 个维度：[is_first, is_last]
  
  # 类别映射：将原始标签 1-8 映射到连续标签 0-7
  # 原始标签 0 (噪声) 会被 ignore_label 忽略
  class_mapping:
    1: 0  # 地面 -> 0
    2: 1  # 植被 -> 1
    3: 2  # 车辆 -> 2
    4: 3  # 卡车 -> 3
    5: 4  # 电线 -> 4
    6: 5  # 篱笆 -> 5
    7: 6  # 杆状物 -> 6
    8: 7  # 建筑 -> 7
  
  # 类别名称（按映射后的连续标签顺序）
  class_names: [地面, 植被, 车辆, 卡车, 电线, 篱笆, 杆状物, 建筑]
  
  ignore_label: -1  # 标签 0 会被映射为 -1
  
  # DataLoader 配置
  batch_size: 8
  num_workers: 4
  pin_memory: true
  persistent_workers: true
  
  # 动态批次配置
  use_dynamic_batch: true  # 训练时使用动态批次
  max_points: 500000  # 每批次最大点数
  
  use_dynamic_batch_inference: true  # 推理时也使用动态批次
  max_points_inference: 500000
  
  # 循环配置
  train_loop: 4  # 训练数据增强循环 4 次
  val_loop: 2    # 验证 TTA 循环 2 次
  test_loop: 2   # 测试 TTA 循环 2 次
  predict_loop: 2  # 预测 TTA 循环 2 次
  
  # 数据增强配置
  train_transforms:
    # 坐标增强
    - type: RandomRotate
      angle: [-180, 180]
      axis: z
      p: 0.5
    
    - type: RandomScale
      scale: [0.9, 1.1]
      # 注意：RandomScale 没有 p 参数，总是应用
    
    - type: RandomFlip
      p: 0.5
    
    - type: RandomJitter
      sigma: 0.01
      clip: 0.05
      # 注意：RandomJitter 没有 p 参数，总是应用
    
    # 噪声注入：双边极端噪声（高空和低空）
    - type: AddExtremeOutliers
      ratio: 0.01  # 1% 噪点
      height_range: [-10, 100]  # Z 坐标范围
      height_mode: bimodal  # 双峰分布（高空+低空）
      intensity_range: [0, 1]
      color_value: [128, 128, 128]
      class_label: ignore  # 噪点标记为 ignore
      p: 0.5
    
    # Echo 特征增强（可选，目前 AddExtremeOutliers 已处理）
    # Echo 特征 [N, 2]：[is_first_return, is_last_return]
    # - [1, 1]: 单次回波
    # - [1, 0]: 首次回波
    # - [0, 1]: 末次回波
    # - [0, 0]: 中间回波
  
  val_transforms:
    # 验证集不做数据增强，但可以做 TTA
    []
  
  test_transforms:
    []
  
  predict_transforms:
    []

# ============================================================================
# 模型配置
# ============================================================================
model:
  type: SemanticSegmentationTask
  
  # 骨干网络
  backbone: PointNet++  # 或其他已实现的骨干网络
  
  # 分类头配置
  num_classes: 8  # 映射后的类别数（0-7）
  in_channels: 3  # coord (3) + echo (2) = 5，但需要检查实际输入
  
  # 损失函数配置
  loss:
    - type: CrossEntropyLoss
      weight: 1.0  # 损失权重
      class_weights: auto  # 自动从数据集计算类别权重
      ignore_index: -1
    
    - type: LovaszLoss
      weight: 0.2  # LAC Loss 权重 0.2
      ignore_index: -1
  
  # 优化器配置
  learning_rate: 0.001
  optimizer: AdamW
  weight_decay: 0.0001
  
  # 学习率调度器
  scheduler: CosineAnnealingLR
  scheduler_params:
    T_max: 100
    eta_min: 0.00001
  
  # 评估指标
  ignore_label: -1

# ============================================================================
# 训练配置
# ============================================================================
trainer:
  max_epochs: 100
  devices: 1
  accelerator: gpu
  precision: 16-mixed  # 混合精度训练
  
  # 日志配置
  log_every_n_steps: 10
  
  # 检查点配置
  default_root_dir: ./outputs/dales
  
  callbacks:
    # 检查点保存
    - type: ModelCheckpoint
      monitor: val_MeanIoU
      mode: max
      save_top_k: 3
      filename: "dales-{epoch:02d}-{val_MeanIoU:.4f}"
    
    # 早停
    - type: EarlyStopping
      monitor: val_MeanIoU
      patience: 20
      mode: max
    
    # 学习率监控
    - type: LearningRateMonitor
      logging_interval: step
    
    # 预测结果写回 LAS 文件
    - type: SegmentationWriter
      output_dir: E:\data\DALES\dales_las\bin\result
      save_logits: false  # 不保存 logits
      auto_infer_reverse_mapping: true  # 自动推断反向映射

# ============================================================================
# 其他配置
# ============================================================================
seed: 42
