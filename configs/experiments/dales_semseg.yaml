# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# DALES è¯­ä¹‰åˆ†å‰²å®éªŒé…ç½®
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 
# è¿™æ˜¯å®éªŒçš„ä¸»é…ç½®æ–‡ä»¶ï¼Œç»Ÿé¢†æ‰€æœ‰å­é…ç½®
# é€šè¿‡ defaults å¼•ç”¨å­é…ç½®ï¼Œç„¶åå¯ä»¥è¦†ç›–ä»»æ„å‚æ•°
#
# ä½¿ç”¨æ–¹å¼:
#   python main.py --config configs/experiments/dales_semseg.yaml
#   python main.py -c configs/experiments/dales_semseg.yaml --run.mode test
#
# é…ç½®å±‚çº§:
#   defaults (å­é…ç½®) â†’ experiment è¦†ç›– â†’ å‘½ä»¤è¡Œè¦†ç›–
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# å¼•ç”¨å­é…ç½®æ–‡ä»¶ (æä¾›é»˜è®¤å€¼)
defaults:
  - data: dales.yaml          # æ•°æ®é›†é…ç½® (è·¯å¾„ã€ç±»åˆ«ã€åŠ è½½ã€å¢å¼º)
  - model: ptv2_semseg.yaml   # æ¨¡å‹æ¶æ„é…ç½® (backboneã€head)
  - trainer: default.yaml     # è®­ç»ƒå™¨é…ç½® (è®­ç»ƒå‚æ•°ã€ä¼˜åŒ–å™¨ã€å›è°ƒ)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# è¿è¡Œé…ç½® (Run Configuration)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# æ§åˆ¶å®éªŒè¿è¡Œæ¨¡å¼ã€è¾“å‡ºä½ç½®ç­‰åŸºæœ¬ä¿¡æ¯
run:
  # è¿è¡Œæ¨¡å¼:
  #   - train: ä»å¤´å¼€å§‹è®­ç»ƒ
  #   - resume: ä»æ£€æŸ¥ç‚¹æ¢å¤è®­ç»ƒ (ç»§ç»­è®­ç»ƒï¼Œä¿ç•™ä¼˜åŒ–å™¨çŠ¶æ€)
  #   - finetune: ä»é¢„è®­ç»ƒæƒé‡å¾®è°ƒ (é‡ç½®ä¼˜åŒ–å™¨çŠ¶æ€)
  #   - test: åœ¨æµ‹è¯•é›†ä¸Šè¯„ä¼°æ¨¡å‹æ€§èƒ½
  #   - predict: å¯¹æ–°æ•°æ®è¿›è¡Œé¢„æµ‹å¹¶è¾“å‡ºç»“æœ
  mode: train
  
  # éšæœºç§å­: ç¡®ä¿å®éªŒå¯å¤ç° (å›ºå®šéšæœºæ•°ç”Ÿæˆå™¨)
  seed: 42
  
  # è¾“å‡ºç›®å½•: å­˜æ”¾æ£€æŸ¥ç‚¹ã€æ—¥å¿—ã€é¢„æµ‹ç»“æœç­‰æ‰€æœ‰è¾“å‡º
  output_dir: ./outputs/dales_semseg
  
  # æ£€æŸ¥ç‚¹è·¯å¾„: resume/finetune/test/predict æ¨¡å¼å¿…é¡»æŒ‡å®š
  # ç¤ºä¾‹: ./outputs/dales_semseg/checkpoints/epoch=50-mean_iou=0.8500.ckpt
  checkpoint_path: null

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# æ•°æ®é…ç½®è¦†ç›– (Data Configuration Override)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# è¦†ç›– defaults.data (dales.yaml) ä¸­çš„é»˜è®¤å€¼
data:
  # æ•°æ®è·¯å¾„ (å¿…é¡»é…ç½®ï¼Œå› ä¸º dales.yaml ä¸­é»˜è®¤ä¸º null)
  paths:
    train: E:/data/DALES/dales_las/bin_logical/train    # è®­ç»ƒé›†ç›®å½• (åŒ…å« .bin/.pkl æ–‡ä»¶)
    val: E:/data/DALES/dales_las/bin_logical/test       # éªŒè¯é›†ç›®å½•
    test: E:/data/DALES/dales_las/bin_logical/test      # æµ‹è¯•é›†ç›®å½•
    predict: E:/data/DALES/dales_las/bin_logical/test   # é¢„æµ‹æ•°æ®ç›®å½•
  
  # å¯é€‰è¦†ç›–ç¤ºä¾‹:
  # loader:
  #   batch_size: 8               # å¢å¤§æ‰¹æ¬¡å¤§å° (éœ€è¦æ›´å¤šæ˜¾å­˜)
  #   num_workers: 8              # å¢åŠ æ•°æ®åŠ è½½çº¿ç¨‹æ•°
  #   dynamic_batch:
  #     max_points_train: 200000  # å¢å¤§æ¯æ‰¹æœ€å¤§ç‚¹æ•°

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# æ¨¡å‹é…ç½®è¦†ç›– (Model Configuration Override)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# è¦†ç›– defaults.model (ptv2_semseg.yaml) ä¸­çš„é»˜è®¤å€¼
model:
  # åˆ†å‰²å¤´é…ç½®
  head:
    init_args:
      # num_classes: è¾“å‡ºç±»åˆ«æ•°ï¼Œä»æ•°æ®é…ç½®è‡ªåŠ¨è·å–
      # ä½¿ç”¨ ${} è¯­æ³•å¼•ç”¨å…¶ä»–é…ç½®èŠ‚ç‚¹çš„å€¼
      num_classes: ${data.classes.num_classes}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# è®­ç»ƒé…ç½®è¦†ç›– (Trainer Configuration Override)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# è¦†ç›– defaults.trainer (default.yaml) ä¸­çš„é»˜è®¤å€¼
trainer:
  # å›è°ƒå‡½æ•°é…ç½® (åˆå¹¶åˆ° trainer.callbacks)
  callbacks:
    # é¢„æµ‹ç»“æœå†™å…¥å™¨ (ä»… predict æ¨¡å¼ä½¿ç”¨)
    # å°†é¢„æµ‹ç»“æœä¿å­˜ä¸º LAS æ ¼å¼ç‚¹äº‘æ–‡ä»¶
    predict_writer:
      enabled: true                # æ˜¯å¦å¯ç”¨æ­¤å›è°ƒ
      class_path: pointsuite.utils.callbacks.SemanticPredictLasWriter
      init_args:
        # è¾“å‡ºç›®å½•: é¢„æµ‹ç»“æœä¿å­˜ä½ç½®
        # ä½¿ç”¨ ${run.output_dir} ç¡®ä¿ä¸ä¸»è¾“å‡ºç›®å½•ä¸€è‡´
        output_dir: ${run.output_dir}/predictions
        # æ˜¯å¦ä¿å­˜ logits: ä¿å­˜æ¯ä¸ªç‚¹çš„é¢„æµ‹æ¦‚ç‡å‘é‡
        # true ä¼šæ˜¾è‘—å¢åŠ æ–‡ä»¶å¤§å°ï¼Œç”¨äºåå¤„ç†æˆ–ä¸ç¡®å®šæ€§åˆ†æ
        save_logits: false
        # è‡ªåŠ¨æ¨æ–­åå‘æ˜ å°„: è‡ªåŠ¨å°†è®­ç»ƒæ ‡ç­¾è½¬æ¢å›åŸå§‹æ ‡ç­¾
        # åŸºäº class_mapping é…ç½®åæ¨
        auto_infer_reverse_mapping: true
  
  # å¯é€‰: è¦†ç›–è®­ç»ƒå‚æ•°
  # training:
  #   max_epochs: 50              # å‡å°‘è®­ç»ƒè½®æ•°
  #   accumulate_grad_batches: 4  # å¢å¤§æ¢¯åº¦ç´¯ç§¯ (ç­‰æ•ˆå¢å¤§ batch_size)
  
  # å¯é€‰: è¦†ç›–ä¼˜åŒ–å™¨å‚æ•°
  # optimizer:
  #   init_args:
  #     lr: 0.0005                # é™ä½å­¦ä¹ ç‡

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ä»»åŠ¡é…ç½® (Task Configuration)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# å®šä¹‰ PyTorch Lightning Module çš„é…ç½®
# Task å°è£…äº†: æ¨¡å‹å‰å‘ä¼ æ’­ã€æŸå¤±è®¡ç®—ã€æŒ‡æ ‡è®¡ç®—ã€ä¼˜åŒ–å™¨é…ç½®
task:
  # ä»»åŠ¡ç±»è·¯å¾„: è¯­ä¹‰åˆ†å‰²ä»»åŠ¡
  class_path: pointsuite.tasks.SemanticSegmentationTask
  init_args:
    # åˆå§‹å­¦ä¹ ç‡ (ä¼šè¢« trainer.optimizer é…ç½®è¦†ç›–)
    learning_rate: 0.001
    # ç±»åˆ«æ˜ å°„: ç”¨äºé¢„æµ‹åå°†è®­ç»ƒæ ‡ç­¾è½¬æ¢å›åŸå§‹æ ‡ç­¾
    # ä¾‹å¦‚: è®­ç»ƒæ ‡ç­¾ 0-7 è½¬æ¢å›åŸå§‹æ ‡ç­¾ 1-8
    class_mapping: ${data.classes.mapping}
    # ç±»åˆ«åç§°: ç”¨äºæ—¥å¿—è¾“å‡ºå’Œå¯è§†åŒ–æ˜¾ç¤º
    class_names: ${data.classes.names}
    # å¿½ç•¥æ ‡ç­¾: è®¡ç®—æŸå¤±å’ŒæŒ‡æ ‡æ—¶è·³è¿‡è¯¥æ ‡ç­¾çš„ç‚¹
    # é€šå¸¸ç”¨äºæ ‡è®°æ— æ•ˆç‚¹æˆ–è¾¹ç•Œç‚¹
    ignore_label: ${data.classes.ignore_label}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# æŸå¤±å‡½æ•°é…ç½® (Loss Configuration)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# å®šä¹‰è®­ç»ƒä½¿ç”¨çš„æŸå¤±å‡½æ•°ï¼Œæ”¯æŒç»„åˆå¤šä¸ªæŸå¤±å‡½æ•°
# 
# ğŸ“Œ ä¸ºä»€ä¹ˆæ”¾åœ¨ experiment è€Œé model:
#   1. æŸå¤±å‡½æ•°ä¾èµ–æ•°æ®é…ç½® (ignore_label, num_classes, class_weights)
#   2. ä¸åŒå®éªŒå¯èƒ½ä½¿ç”¨åŒä¸€æ¨¡å‹ä½†ä¸åŒæŸå¤±ç»„åˆ
#   3. experiment å®šä¹‰"å¦‚ä½•è®­ç»ƒ"ï¼Œmodel å®šä¹‰"ç½‘ç»œç»“æ„"
#   4. ä¾¿äºå¿«é€Ÿåˆ‡æ¢æŸå¤±å‡½æ•°è¿›è¡Œæ¶ˆèå®éªŒ
losses:
  # äº¤å‰ç†µæŸå¤± (Cross Entropy Loss)
  # åˆ†ç±»ä»»åŠ¡çš„æ ‡å‡†æŸå¤±å‡½æ•°ï¼Œè¡¡é‡é¢„æµ‹åˆ†å¸ƒä¸çœŸå®åˆ†å¸ƒçš„å·®å¼‚
  - name: ce_loss                                          # æŸå¤±åç§° (ç”¨äºæ—¥å¿—æ˜¾ç¤º)
    class_path: pointsuite.models.losses.CrossEntropyLoss  # æŸå¤±å‡½æ•°ç±»è·¯å¾„
    init_args:
      # å¿½ç•¥ç´¢å¼•: è¯¥æ ‡ç­¾çš„ç‚¹ä¸å‚ä¸æŸå¤±è®¡ç®—
      ignore_index: ${data.classes.ignore_label}
      # weight: ç±»åˆ«æƒé‡ï¼Œç”¨äºå¤„ç†ç±»åˆ«ä¸å¹³è¡¡
      # null æ—¶è‡ªåŠ¨ä» datamodule.class_weights è·å–
    weight: 1.0                                            # è¯¥æŸå¤±çš„æƒé‡ç³»æ•°
    
  # å¯é€‰: Lovasz æŸå¤± (ç›´æ¥ä¼˜åŒ– IoU/Jaccard æŒ‡æ ‡)
  # é€‚åˆè¯­ä¹‰åˆ†å‰²ä»»åŠ¡ï¼Œå°¤å…¶æ˜¯ç±»åˆ«ä¸å¹³è¡¡åœºæ™¯
  # - name: lovasz_loss
  #   class_path: pointsuite.models.losses.LovaszLoss
  #   init_args:
  #     ignore_index: ${data.classes.ignore_label}
  #     mode: multiclass          # å¤šåˆ†ç±»æ¨¡å¼ (softmax)
  #   weight: 1.0
  
  # å¯é€‰: Dice æŸå¤± (å¤„ç†ç±»åˆ«ä¸å¹³è¡¡)
  # åŸºäº F1 åˆ†æ•°ï¼Œå¯¹å°ç›®æ ‡æ›´æ•æ„Ÿ
  # - name: dice_loss
  #   class_path: pointsuite.models.losses.DiceLoss
  #   init_args:
  #     ignore_index: ${data.classes.ignore_label}
  #     smooth: 1.0               # å¹³æ»‘å› å­ï¼Œé˜²æ­¢é™¤é›¶
  #   weight: 0.5

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# æŒ‡æ ‡é…ç½® (Metrics Configuration)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# å®šä¹‰è¯„ä¼°æŒ‡æ ‡ï¼Œç”¨äºç›‘æ§è®­ç»ƒè¿›åº¦å’Œæ¨¡å‹é€‰æ‹©
#
# ğŸ“Œ ä¸ºä»€ä¹ˆæ”¾åœ¨ experiment è€Œé model:
#   1. æŒ‡æ ‡è®¡ç®—ä¾èµ–æ•°æ®é…ç½® (num_classes, class_names, ignore_label)
#   2. ä¸åŒå®éªŒå¯èƒ½å…³æ³¨ä¸åŒæŒ‡æ ‡ç»„åˆ
#   3. ä¸æŸå¤±å‡½æ•°ä¿æŒä¸€è‡´çš„é…ç½®é£æ ¼
metrics:
  # è¯­ä¹‰åˆ†å‰²æŒ‡æ ‡é›†åˆ
  # åŒ…å«: mIoU, OA (Overall Accuracy), Per-class IoU, F1 ç­‰
  - name: seg_metrics                                      # æŒ‡æ ‡åç§° (ç”¨äºæ—¥å¿—æ˜¾ç¤º)
    class_path: pointsuite.utils.metrics.semantic_segmentation.SegmentationMetrics
    init_args:
      # ç±»åˆ«æ•°é‡: ç”¨äºåˆå§‹åŒ–æ··æ·†çŸ©é˜µ
      num_classes: ${data.classes.num_classes}
      # å¿½ç•¥ç´¢å¼•: è¯¥æ ‡ç­¾çš„ç‚¹ä¸å‚ä¸æŒ‡æ ‡è®¡ç®—
      ignore_index: ${data.classes.ignore_label}
      # ç±»åˆ«åç§°: ç”¨äºè¾“å‡ºæ¯ç±»æŒ‡æ ‡æ—¶çš„æ ‡ç­¾æ˜¾ç¤º
      class_names: ${data.classes.names}
